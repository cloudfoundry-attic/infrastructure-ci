#!/bin/bash -exu

cwd=${PWD}
configure_om_dir="${PWD}/ci/scripts/terraforming/configure-om"

terraform output -state "${cwd}/terraform-state-gcp/terraform.tfstate" --json | \
  jq '[. | to_entries[] | {"key": .key, "value": .value.value}] | from_entries' \
  > "${cwd}/tfoutput.json"

pushd srt
  version="$(unzip -p srt*.pivotal 'metadata/*.yml' | grep '^product_version:' | cut -d" " -f2 | sed 's/"//g')"
popd

stemcell="$(ls -1 "${cwd}"/stemcell/*.tgz)"
opsman_dns=$(jq -r .ops_manager_dns < "${cwd}/tfoutput.json")

# generate-config
texplate execute "${configure_om_dir}/config-director-template.yml" -f "${cwd}/tfoutput.json" -o yaml > "${cwd}/director-config.yml"
texplate execute "${configure_om_dir}/config-product-template.yml" -f "${cwd}/tfoutput.json" -o yaml > "${cwd}/product-config.yml"

# configure authentication
om -t "https://${opsman_dns}" -k configure-authentication -u ${OM_USERNAME} -p ${OM_PASSWORD} -dp ${OM_PASSWORD}

# upload and stage product
om -t "https://${opsman_dns}" -k -u ${OM_USERNAME} -p ${OM_PASSWORD} upload-stemcell --stemcell "${stemcell}"
om -t "https://${opsman_dns}" -k -u ${OM_USERNAME} -p ${OM_PASSWORD} upload-product --product "${product}"
om -t "https://${opsman_dns}" -k -u ${OM_USERNAME} -p ${OM_PASSWORD} stage-product --product-name cf --product-version "${version}"

# configure-product
om -t "https://${opsman_dns}" -k -u ${OM_USERNAME} -p ${OM_PASSWORD} configure-director --config "${cwd}/director-config.yml"
om -t "https://${opsman_dns}" -k -u ${OM_USERNAME} -p ${OM_PASSWORD} configure-product -n cf --config "${cwd}/product-config.yml"
